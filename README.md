# Autoplan Agent

åŸºäº LangChain/LangGraph çš„è‡ªä¸»è§„åˆ’æ•°æ®åˆ†æä¸å¼‚å¸¸æ£€æµ‹æ™ºèƒ½ä½“ç³»ç»Ÿã€‚æä¾› FastAPI æœåŠ¡ä¸ CLI å‘½ä»¤è¡Œå·¥å…·ï¼Œæ”¯æŒä»ä»»åŠ¡ç†è§£ã€è®¡åˆ’ç”Ÿæˆã€äº¤äº’å¼ç¡®è®¤åˆ°åŠ¨æ€æ‰§è¡Œä¸å¤šæ ¼å¼æŠ¥å‘Šï¼ˆMarkdown/HTML/PDFï¼‰ç”Ÿæˆçš„å…¨æµç¨‹è‡ªåŠ¨åŒ–ã€‚

## ğŸŒŸ æ ¸å¿ƒåŠŸèƒ½

- **ä»»åŠ¡æ·±åº¦ç†è§£**ï¼šåˆ©ç”¨ LLM è§£æç”¨æˆ·éœ€æ±‚ï¼Œè¾“å‡ºç»“æ„åŒ–çš„ä»»åŠ¡ç†è§£æŠ¥å‘Šï¼ˆç›®æ ‡ã€èŒƒå›´ã€çº¦æŸã€äº¤ä»˜ç‰©ï¼‰ã€‚
- **åŠ¨æ€è§„åˆ’å¼•æ“**ï¼šç»“åˆé¢„è®¾æ¨¡æ¿ä¸æ•°æ®åº“ Schemaï¼Œè‡ªåŠ¨ç”ŸæˆåŒ…å« SQL æŸ¥è¯¢ã€æ¸…æ´—ã€åˆ†æã€å¯è§†åŒ–çš„å¤šæ­¥éª¤æ‰§è¡Œè®¡åˆ’ã€‚
- **äº¤äº’å¼å¾ªç¯**ï¼šæ”¯æŒç”¨æˆ·å¯¹è®¡åˆ’è¿›è¡Œåé¦ˆä¿®æ”¹ï¼Œè§¦å‘å†è§„åˆ’ï¼ˆRe-planningï¼‰ï¼Œç¡®ä¿åˆ†ææ–¹å‘å‡†ç¡®ã€‚
- **å¼ºåŠ›æ‰§è¡Œå·¥å…·ç®±**ï¼š
  - **MySQL å¢å¼º**ï¼šæ”¯æŒå¤æ‚æŸ¥è¯¢ã€SQL å®‰å…¨å«å£«ä¸æ‰§è¡Œè®¡åˆ’ï¼ˆEXPLAINï¼‰åˆ†æã€‚
  - **æ•°æ®å¤„ç†**ï¼šå†…ç½®æ¸…æ´—ï¼ˆCleaningï¼‰ã€æ¢ç´¢æ€§åˆ†æï¼ˆEDAï¼‰ã€ç»Ÿè®¡æ£€éªŒï¼ˆStatsï¼‰ã€‚
  - **æ™ºèƒ½æŒ–æ˜**ï¼šé›†æˆå¼‚å¸¸æ£€æµ‹ï¼ˆAnomaly Detectionï¼‰ã€è¶‹åŠ¿åˆ†æç­‰ç®—æ³•ã€‚
  - **å¤šç»´å¯è§†åŒ–**ï¼šæ”¯æŒ Plotly ä¸ Matplotlib æ¸²æŸ“ã€‚
- **è‡ªåŠ¨åŒ–æŠ¥å‘Š**ï¼šæ±‡æ€»æ‰§è¡Œäº§ç‰©ï¼ŒåŸºäº Jinja2 æ¨¡æ¿ç”Ÿæˆä¸“ä¸šåˆ†ææŠ¥å‘Šã€‚
- **é«˜å¯é æ€§**ï¼šåˆ©ç”¨ LangGraph Checkpoint å®ç°ä»»åŠ¡ä¸­æ–­æ¢å¤ä¸çŠ¶æ€æŒä¹…åŒ–ã€‚

## ğŸ“‚ é¡¹ç›®ç»“æ„

```text
.
â”œâ”€â”€ api/                # FastAPI æœåŠ¡å…¥å£åŠè·¯ç”±å®šä¹‰ (health, runs)
â”œâ”€â”€ autoplan_agent/     # æ ¸å¿ƒé€»è¾‘æ¡†æ¶
â”‚   â”œâ”€â”€ llm/            # LLM é€‚é…ã€Jinja2 æç¤ºè¯æ¨¡æ¿ä¸ JSON è§£æ
â”‚   â”œâ”€â”€ schemas/        # Pydantic ç»Ÿä¸€æ•°æ®æ¨¡å‹ (API, Plan, Artifactsç­‰)
â”‚   â”œâ”€â”€ storage/        # è¿è¡Œæ•°æ®æŒä¹…åŒ– (RunStore) ä¸ LangGraph Checkpoint
â”‚   â”œâ”€â”€ tools/          # å†…ç½®å·¥å…·ç®±ï¼ˆMySQL, DFå¤„ç†, ç»Ÿè®¡, å¯è§†åŒ–, æŠ¥å‘Šï¼‰
â”‚   â”œâ”€â”€ config.py       # åŸºäº Pydantic Settings çš„å…¨å±€é…ç½®
â”‚   â”œâ”€â”€ executor.py     # è®¡åˆ’æ‰§è¡Œå¼•æ“
â”‚   â”œâ”€â”€ workflow.py     # LangGraph çŠ¶æ€æœºç¼–æ’
â”‚   â””â”€â”€ logging_.py     # æ—¥å¿—ç»Ÿä¸€é…ç½®
â”œâ”€â”€ cli/                # Typer å‘½ä»¤è¡Œå…¥å£
â”œâ”€â”€ scripts/            # è¾…åŠ©è„šæœ¬ï¼ˆæ•°æ®åŠ è½½ã€çŠ¶æ€æ£€æŸ¥ã€æŠ¥å‘Šé‡ç®—ï¼‰
â”œâ”€â”€ templates/          # æ¨¡æ¿åº“ (Plans YAML, Jinja2 Reports, Business Rules)
â”œâ”€â”€ tests/              # å•å…ƒæµ‹è¯•ä¸é›†æˆæµ‹è¯•
â”œâ”€â”€ main.py             # å¿«é€Ÿå¯åŠ¨å…¥å£ï¼ˆCLI ä»£ç†ï¼‰
â””â”€â”€ utils.py            # å·¥å…·å‡½æ•°ï¼ˆå¦‚æ¨¡å‹åˆå§‹åŒ–é€‚é…ï¼‰
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå‡†å¤‡

æ¨èä½¿ç”¨ [uv](https://github.com/astral-sh/uv) æˆ– `pip` ç®¡ç†ç¯å¢ƒï¼š

```bash
# ä½¿ç”¨ uv
uv venv
source .venv/bin/activate
uv pip install -e .[dev,data]

# æˆ–ä½¿ç”¨ä¼ ç»Ÿ pip
python -m venv .venv
source .venv/bin/activate
pip install -e .[dev,data]
```

### 2. é…ç½®ç¯å¢ƒå˜é‡

å¤åˆ¶ `.env.example` å¹¶é…ç½®å…³é”®å‚æ•°ï¼š

```bash
cp .env.example .env
```

**å…³é”®é…ç½®é¡¹ï¼š**
- `MODEL`: LLM æ¨¡å‹åç§° (é»˜è®¤ Qwen3-30B ç³»åˆ—)
- `MODEL_BASE_URL`: OpenAI å…¼å®¹çš„ API åœ°å€
- `OPENAI_API_KEY`: API å¯†é’¥
- `MYSQL_URL`: æ•°æ®åº“è¿æ¥ä¸²ï¼ˆä¾‹å¦‚ `mysql+pymysql://user:pass@host:3306/db`ï¼‰
- `AGENT_API_KEY`: API æœåŠ¡é‰´æƒå¯†é’¥ (å¯é€‰)
- `RUNS_DIR`: è¿è¡Œäº§ç‰©å­˜å‚¨ç›®å½• (é»˜è®¤ `./runs`)
- `LLM_FAKE=1`: å¼€å¯ç¦»çº¿æ¨¡æ‹Ÿæ¨¡å¼ï¼ˆæ— éœ€çœŸå® LLMï¼‰

### 3. è¿è¡Œæ–¹å¼

#### A. å‘½ä»¤è¡Œäº¤äº’ (CLI)
```bash
# å¯åŠ¨äº¤äº’å¼åˆ†æä»»åŠ¡ (åŒ…å« ç†è§£ -> ç¡®è®¤ -> æ‰§è¡Œ -> æŠ¥å‘Š å…¨æµç¨‹)
autoplan-agent run "åˆ†æè¿‡å»30å¤©è®¢å•é€€æ¬¾ç‡å¼‚å¸¸çš„åŸå› "

# ç»§ç»­æ‰§è¡Œä¸­æ–­çš„ä»»åŠ¡ (åŸºäº run_id)
autoplan-agent resume <run_id>

# ä»…æŸ¥çœ‹/ç”ŸæˆæŠ¥å‘Š
autoplan-agent report <run_id> --fmt pdf
```

#### B. API æœåŠ¡
```bash
# å¯åŠ¨æœåŠ¡
autoplan-agent serve --port 8000

# API è°ƒç”¨ç¤ºä¾‹ï¼šåˆ›å»ºä»»åŠ¡ (è‹¥é…ç½®äº† AGENT_API_KEYï¼Œè¯·æ·»åŠ  X-API-Key Header)
curl -X POST http://localhost:8000/v1/runs \
  -H "Content-Type: application/json" \
  -H "X-API-Key: your_key_here" \
  -d '{"user_task":"åˆ†æè¿‘æœŸæ”¯ä»˜å¤±è´¥ç‡æƒ…å†µ", "template_id": "default"}'
```

## ğŸ› ï¸ æ ¸å¿ƒå·¥ä½œæµ

ç³»ç»ŸåŸºäº **LangGraph** æ„å»ºï¼Œå®ç°äº†å¸¦æœ‰äººæœºäº¤äº’ï¼ˆHuman-in-the-loopï¼‰çš„çŠ¶æ€æœºï¼š

1. **Understand**: ç»“åˆæ•°æ®åº“ Schema Hintï¼Œåˆ©ç”¨ LLM è§£æéœ€æ±‚ï¼Œäº§å‡º `TaskUnderstandingReport`ã€‚
2. **Apply Feedback**: è‹¥ç”¨æˆ·æä¾›ä¿®æ”¹æ„è§ï¼Œç³»ç»Ÿå°†æ›´æ–°ä»»åŠ¡ç†è§£å¹¶æ ‡è®°æ—§è®¡åˆ’å¤±æ•ˆã€‚
3. **Plan**: ç»“åˆ `template_id` (YAML) ä¸ç†è§£æŠ¥å‘Šï¼Œè‡ªåŠ¨ç”Ÿæˆå¤šæ­¥éª¤ `ExecutionPlan`ã€‚
4. **Confirm**: çŠ¶æ€æœºè¿›å…¥ `NEEDS_CONFIRMATION`ï¼Œç­‰å¾…ç”¨æˆ·å®¡æ‰¹æˆ–åé¦ˆã€‚
5. **Execute**: éå†è®¡åˆ’æ­¥éª¤ï¼ŒæŒ‰åºè°ƒç”¨å·¥å…·ç®±ï¼Œå®æ—¶äº§å‡º `Artifacts`ï¼ˆParquet/JSON/Imagesï¼‰ã€‚
6. **Report**: æ±‡æ€»æ‰§è¡Œäº§ç‰©ï¼ŒåŸºäº Jinja2 æ¨¡æ¿æ¸²æŸ“ç”Ÿæˆ Markdown/HTML/PDF ä¸“ä¸šåˆ†ææŠ¥å‘Šã€‚

## ğŸ§© æ‰©å±•ä¸è‡ªå®šä¹‰

- **è‡ªå®šä¹‰è®¡åˆ’æ¨¡æ¿**ï¼šåœ¨ `templates/plans/` ä¸‹æ·»åŠ  YAMLï¼Œå®šä¹‰å„æ­¥éª¤çš„é»˜è®¤å·¥å…·ä¸ä¾èµ–å…³ç³»ã€‚
- **è‡ªå®šä¹‰ä¸šåŠ¡è§„åˆ™**ï¼šåœ¨ `templates/business_rules/` ä¸­å®šä¹‰è¡Œä¸šç‰¹å®šçš„è®¡ç®—é€»è¾‘æˆ–çº¦æŸã€‚
- **è‡ªå®šä¹‰å·¥å…·æ’ä»¶**ï¼šé€šè¿‡ `PLUGINS_DIR` åŠ¨æ€åŠ è½½ Python å·¥å…·åŒ…ã€‚
- **å¤šæ¨¡å‹é€‚é…**ï¼šåœ¨ [utils.py](file:///Users/lzc/TNTprojectZ/AwesomeLangchainTutorial/AutoPlanAgent/AutoPlanAgent-CodeX/utils.py) ä¸­æ‰©å±• `get_model_from_name` ä»¥æ”¯æŒæ›´å¤š LLM ä¾›åº”å•†ã€‚

